<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    // Keep this page behind your simple gate, just like About/Index.
    <script>
  // Keep this page behind your simple gate, just like About/Index.
  if (sessionStorage.getItem('reefAuth') !== 'ok') {
    location.href = 'login.html';
  }
</script>
  <meta name="robots" content="noindex, nofollow" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Review ‚Äî Reef Architect</title>
  <link rel="stylesheet" href="styles.css"/>

  <!-- jsPDF (client-side PDF creation) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- EmailJS (client-side email) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    .page { max-width: 900px; margin: 0 auto; padding: 16px; }
    .grid-2-form { display: grid; grid-template-columns: 220px 1fr; gap: 10px; }
    @media (max-width: 700px){ .grid-2-form { grid-template-columns: 1fr; } }
    .questions .card { padding-top: 8px; }
    .help { font-size: .9rem; color: var(--muted); margin-top: 4px; }
    .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .thankyou { display:none; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
  <img src="Images/logo.png" alt="Reef Architect logo" style="height:40px; vertical-align:middle; border-radius:8px;">
  <span class="subtitle">Plan ‚Ä¢ Build ‚Ä¢ Thrive</span>
</div>
    <nav class="controls">
      <a href="index.html" class="secondary">Home</a>
      <a href="crash-course.html" class="cta">Crash Course</a>
      <a href="about.html" class="secondary">About</a>
      <a href="feedback.html" class="secondary">Review</a>
      <button id="themeToggle" class="secondary" aria-pressed="false">üåó Theme</button>
    </nav>
  </header>

  <main class="page">
    <section class="card">
      <h2>Help me make Reef Architect better</h2>
      <p class="small muted">
        This short survey emails your responses to my project inbox and also lets you download a PDF copy.
      </p>
    </section>

    <form id="reviewForm" class="questions" autocomplete="on">
      <section class="card">
        <h3>Your Info</h3>
        <div class="grid-2-form">
          <label for="revName">Name</label>
          <input id="revName" name="name" type="text" placeholder="Optional" />

          <label for="revEmail">Email</label>
          <input id="revEmail" name="email" type="email" placeholder="Optional (for follow-up)" />

          <label for="revRole">How do you describe yourself?</label>
          <select id="revRole" name="role">
            <option value="">‚Äî Select ‚Äî</option>
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Advanced</option>
            <option>Retailer / Brand</option>
            <option>Content Creator</option>
            <option>Other</option>
          </select>

          <label for="revDevice">What device did you use?</label>
          <select id="revDevice" name="device">
            <option value="">‚Äî Select ‚Äî</option>
            <option>Desktop/Laptop</option>
            <option>Tablet</option>
            <option>Phone</option>
          </select>
        </div>
      </section>

      <section class="card">
        <h3>Your Visit</h3>
        <div class="grid-2-form">
          <label for="revTime">About how long did you explore?</label>
          <select id="revTime" name="visit_length">
            <option value="">‚Äî Select ‚Äî</option>
            <option>&lt; 5 min</option>
            <option>5‚Äì15 min</option>
            <option>15‚Äì30 min</option>
            <option>30‚Äì60 min</option>
            <option>1+ hour</option>
          </select>

          <label>Which sections did you use?</label>
          <div class="inline" id="sectionsWrap">
            <label><input type="checkbox" name="sections_used" value="Welcome"> Welcome</label>
            <label><input type="checkbox" name="sections_used" value="Stage 1"> Tank & Equipment</label>
            <label><input type="checkbox" name="sections_used" value="Stage 2"> Fish & Inverts</label>
            <label><input type="checkbox" name="sections_used" value="Stage 3"> Corals</label>
            <label><input type="checkbox" name="sections_used" value="Stage 4"> Summary</label>
            <label><input type="checkbox" name="sections_used" value="Crash Course"> Crash Course</label>
            <label><input type="checkbox" name="sections_used" value="Glossary"> Glossary</label>
          </div>
        </div>
      </section>

      <section class="card">
        <h3>Ratings (1 = poor, 5 = excellent)</h3>
        <div class="grid-2-form">
          <label>Clarity of UI</label>
          <select name="ui_clarity"><option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option></select>

          <label>Mobile usability</label>
          <select name="mobile_usability"><option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option></select>

          <label>Speed/performance</label>
          <select name="performance"><option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option></select>

          <label>Content helpfulness</label>
          <select name="content_helpfulness"><option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option></select>

          <label>Would you recommend it? (0‚Äì10)</label>
          <input type="number" min="0" max="10" name="nps" value="8" />
        </div>
      </section>

      <section class="card">
        <h3>Open Feedback</h3>
        <div class="grid-2-form">
          <label for="revBugs">Any bugs or broken behavior?</label>
          <textarea id="revBugs" name="bugs" rows="3" placeholder="What didn‚Äôt work, or felt confusing?"></textarea>

          <label for="revImprovements">Top 3 improvements you want</label>
          <textarea id="revImprovements" name="top_improvements" rows="3" placeholder="Be as blunt and specific as you like."></textarea>

          <label for="revLoved">What did you like most?</label>
          <textarea id="revLoved" name="loved" rows="2"></textarea>

          <label for="revOther">Anything else?</label>
          <textarea id="revOther" name="other" rows="2"></textarea>

          <label>May I follow up with you?</label>
          <div class="inline">
            <label><input type="radio" name="follow_up_ok" value="Yes" checked> Yes</label>
            <label><input type="radio" name="follow_up_ok" value="No"> No</label>
          </div>

          <label>May I quote your feedback on the site?</label>
          <div class="inline">
            <label><input type="radio" name="quote_ok" value="Yes"> Yes</label>
            <label><input type="radio" name="quote_ok" value="No" checked> No</label>
          </div>
        </div>
        <p class="help">Submitting will (1) email the responses to my inbox via EmailJS and (2) let you download a PDF copy.</p>
        <div class="inline" style="margin-top:10px">
          <button type="submit" class="primary">Submit & Create PDF</button>
          <button type="reset" class="secondary">Reset</button>
        </div>
      </section>
    </form>

    <section id="thankyou" class="card thankyou">
      <h3>Thank you!</h3>
      <p>Your feedback was submitted. If a PDF didn‚Äôt automatically download, please check your pop-up blocker and submit again.</p>
      <p><a class="secondary" href="index.html">‚Üê Back to Home</a></p>
    </section>
  </main>

  <footer class="footer">
    <span>¬© 2025 Reef Architect</span>
  </footer>

  <script>
    // ---------- Theme reuse ----------
    (function(){
      const btn = document.getElementById('themeToggle');
      function apply(theme){
        document.documentElement.setAttribute('data-theme', theme);
        if(btn){ btn.setAttribute('aria-pressed', theme==='dark'?'true':'false'); btn.textContent = theme==='dark' ? 'üåô Dark' : 'üåû Light'; }
        try{ localStorage.setItem('theme', theme); }catch(e){}
      }
      const saved = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      apply(saved);
      btn?.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        apply(cur==='dark'?'light':'dark');
      });
    })();

    // ---------- EmailJS init ----------
    // 1) Replace with your EmailJS public key:
    emailjs.init({ publicKey: "aTTbQPfXEePcBPeok" });

    const form = document.getElementById('reviewForm');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const fd = new FormData(form);
      // Collect checkbox group into a single comma string:
      const sections = Array.from(document.querySelectorAll('#sectionsWrap input[name="sections_used"]:checked'))
        .map(x=>x.value).join(', ');

      // Template params expected by your EmailJS template (names must match):
      const params = {
        name: fd.get('name') || '',
        email: fd.get('email') || '',
        role: fd.get('role') || '',
        device: fd.get('device') || '',
        visit_length: fd.get('visit_length') || '',
        sections_used: sections || '',
        ui_clarity: fd.get('ui_clarity') || '',
        mobile_usability: fd.get('mobile_usability') || '',
        performance: fd.get('performance') || '',
        content_helpfulness: fd.get('content_helpfulness') || '',
        nps: fd.get('nps') || '',
        bugs: fd.get('bugs') || '',
        top_improvements: fd.get('top_improvements') || '',
        loved: fd.get('loved') || '',
        other: fd.get('other') || '',
        follow_up_ok: fd.get('follow_up_ok') || '',
        quote_ok: fd.get('quote_ok') || '',
        submitted_at: new Date().toLocaleString()
      };

      // 1) Create PDF locally for the reviewer
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'letter' });
        const margin = 54; let y = margin;

        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('Reef Architect ‚Äî Site Review', margin, y); y += 22;
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text(`Submitted: ${params.submitted_at}`, margin, y); y += 18;

        function block(h, v){
          doc.setFont('helvetica','bold'); doc.text(h, margin, y); y += 14;
          doc.setFont('helvetica','normal');
          const text = (v || '‚Äî') + '';
          const lines = doc.splitTextToSize(text, 504);
          lines.forEach(line=>{ doc.text(line, margin, y); y += 12; });
          y += 6;
          if(y > 700){ doc.addPage(); y = margin; }
        }

        block('Name', params.name);
        block('Email', params.email);
        block('Role', params.role);
        block('Device', params.device);
        block('Visit Length', params.visit_length);
        block('Sections Used', params.sections_used);

        block('UI Clarity (1‚Äì5)', params.ui_clarity);
        block('Mobile Usability (1‚Äì5)', params.mobile_usability);
        block('Performance (1‚Äì5)', params.performance);
        block('Content Helpfulness (1‚Äì5)', params.content_helpfulness);
        block('Recommend (0‚Äì10)', params.nps);

        block('Bugs', params.bugs);
        block('Top Improvements', params.top_improvements);
        block('Loved', params.loved);
        block('Other', params.other);
        block('Follow Up OK', params.follow_up_ok);
        block('Quote OK', params.quote_ok);

        const nameSafe = (params.name || 'Anonymous').toString().replace(/[^a-z0-9_\-]+/gi,'_');
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        doc.save(`ReefArchitect_Review_${nameSafe}_${ts}.pdf`);
      } catch(err){
        console.error('PDF error', err);
      }

// 2) Send email via EmailJS (try with PDF attachment; fallback to text-only)
try {
  const SERVICE_ID = "service_xxxxxxxx";     // <-- your real Service ID
  const TEMPLATE_ID = "template_70jp328";    // <-- your real Template ID

  // Build a filename and a base64 string for the PDF we already generated
  const fileName = (()=>{
    const nameSafe = (params.name || 'Anonymous').toString().replace(/[^a-z0-9_\-]+/gi,'_');
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    return `ReefArchitect_Review_${nameSafe}_${ts}.pdf`;
  })();

  // jsPDF: get a base64 string of the PDF (no prefix)
  const pdfDataUri = window.jspdf?.jsPDF ? null : null; // guard (jsPDF already loaded)
  // Recreate the PDF to capture as base64 without changing the already-downloaded file
  const { jsPDF } = window.jspdf;
  const reDoc = new jsPDF({ unit: 'pt', format: 'letter' });
  // (Re-print the same blocks for the attachment)
  const margin2 = 54; let y2 = margin2;
  reDoc.setFont('helvetica','bold'); reDoc.setFontSize(16);
  reDoc.text('Reef Architect ‚Äî Site Review', margin2, y2); y2 += 22;
  reDoc.setFont('helvetica','normal'); reDoc.setFontSize(10);
  reDoc.text(`Submitted: ${params.submitted_at}`, margin2, y2); y2 += 18;
  function writeBlock(h, v){
    reDoc.setFont('helvetica','bold'); reDoc.text(h, margin2, y2); y2 += 14;
    reDoc.setFont('helvetica','normal');
    const txt = (v || '‚Äî') + '';
    const lines = reDoc.splitTextToSize(txt, 504);
    lines.forEach(line=>{ reDoc.text(line, margin2, y2); y2 += 12; });
    y2 += 6;
    if(y2 > 700){ reDoc.addPage(); y2 = margin2; }
  }
  writeBlock('Name', params.name);
  writeBlock('Email', params.email);
  writeBlock('Role', params.role);
  writeBlock('Device', params.device);
  writeBlock('Visit Length', params.visit_length);
  writeBlock('Sections Used', params.sections_used);
  writeBlock('UI Clarity (1‚Äì5)', params.ui_clarity);
  writeBlock('Mobile Usability (1‚Äì5)', params.mobile_usability);
  writeBlock('Performance (1‚Äì5)', params.performance);
  writeBlock('Content Helpfulness (1‚Äì5)', params.content_helpfulness);
  writeBlock('Recommend (0‚Äì10)', params.nps);
  writeBlock('Bugs', params.bugs);
  writeBlock('Top Improvements', params.top_improvements);
  writeBlock('Loved', params.loved);
  writeBlock('Other', params.other);
  writeBlock('Follow Up OK', params.follow_up_ok);
  writeBlock('Quote OK', params.quote_ok);

  const base64NoPrefix = reDoc.output('datauristring').split(',')[1];

  let sent = false;
  try {
    // Some EmailJS plans support base64 attachments via the `attachments` param.
    await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
      ...params,
      attachments: [{
        name: fileName,
        data: base64NoPrefix
      }]
    });
    sent = true;
  } catch (attachErr) {
    console.warn('Attachment send failed, falling back to text-only email', attachErr);
  }

  if (!sent) {
    await emailjs.send(SERVICE_ID, TEMPLATE_ID, params);
  }

  form.style.display = 'none';
  document.getElementById('thankyou').style.display = 'block';
} catch (e2) {
  console.error(e2);
  alert('Email send error ‚Äî please try again.');
}
