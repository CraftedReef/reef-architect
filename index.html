<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  if (sessionStorage.getItem('reefAuth') !== 'ok') {
    location.href = 'login.html';
  }
</script>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🪸 Reef Architect</title>
    <!-- Load user theme before CSS -->
  <script>
    (function(){
      try {
        var saved = localStorage.getItem('theme');
        var t = (saved==='dark'||saved==='light')
          ? saved
          : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', t);
      } catch(e){}
    })();
  </script>

  <link rel="stylesheet" href="styles.css"/>

  <!-- keep inline helpers already used -->
  <style>
    .tooltip { position: relative; display: inline-flex; align-items: center; gap: .5rem; }
    .tooltip .tooltip-text {
      position: absolute; top: 125%; left: 0; max-width: 22rem; padding: .6rem .8rem;
      border-radius: .5rem; background: rgba(0,0,0,.9); color:#fff; font-size: .9rem; line-height: 1.2rem;
      box-shadow: 0 6px 20px rgba(0,0,0,.25); opacity: 0; visibility: hidden; transform: translateY(4px);
      transition: opacity .15s ease, transform .15s ease, visibility .15s; z-index: 9999; pointer-events: none;
    }
    .tooltip .tooltip-text::before {
      content:""; position:absolute; top:-6px; left:12px; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:6px solid rgba(0,0,0,.9);
    }
    .tooltip:hover .tooltip-text, .tooltip:focus-within .tooltip-text { opacity:1; visibility:visible; transform:translateY(0); }
    .tooltip .label-text:focus-visible { box-shadow: 0 0 0 2px #0ea5e9; border-radius: .25rem; }
    .toggle input[type="radio"] { width: 1.1rem; height: 1.1rem; cursor: pointer; }
    .muted { opacity:.7; }
    .compat-list .ok { color: var(--good); }
    .compat-list .caution { color: var(--warn); }
    .compat-list .bad { color: var(--bad); }
  </style>
</head>
<body>
  <script>
  if(sessionStorage.getItem("reefAuth") !== "ok"){
    window.location.href = "login.html";
  }
</script>
  <header class="topbar">
    <div class="brand">
  <img src="Images/logo.png" alt="Reef Architect logo" style="height:40px; vertical-align:middle; border-radius:8px;">
  <span class="subtitle">Plan • Build • Thrive</span>
</div>
    <div class="controls">
      <!-- Experience mode: Beginner / Experienced with hover tooltips -->
      <div class="toggle" role="group" aria-label="Experience level">
        <label class="tooltip">
          <input type="radio" name="experience" id="expBeginner" checked />
          <span class="label-text" tabindex="0">Beginner</span>
          <div class="tooltip-text" role="tooltip">
            Shows beginner-safe fish/corals and gear only. Hides advanced items (UV & reactors) and simplifies choices.
          </div>
        </label>
        <label class="tooltip">
          <input type="radio" name="experience" id="expExperienced" />
          <span class="label-text" tabindex="0">Experienced</span>
          <div class="tooltip-text" role="tooltip">
            Full lists enabled, including advanced gear (UV & reactors) and species that need extra care.
          </div>
        </label>
      </div>

      <a href="welcome.html" class="secondary">Home</a>
      <a href="crash-course.html" class="cta">Crash Course</a>
      <a href="about.html" class="secondary">About</a>
      <a href="feedback.html" class="secondary">Review</a>
      <button id="openGlossary" class="icon-btn">Glossary</button>
          
    </div>
  </header>

  <main id="app">
    <section id="stage-tabs" class="tabs">
      <button class="tab active" data-stage="1">1. Tank & Equipment</button>
      <button class="tab" data-stage="2">
  2. Fish &amp; Inverts
  <span id="animalsBadge" class="badge" aria-label="Total fish and inverts"></span>
</button>
      <button class="tab" data-stage="3">3. Corals</button>
      <button class="tab" data-stage="4">4. Summary</button>
      <button class="tab" data-stage="5">Visualizer</button>
    </section>

        <!-- Stage 1 -->
    <section id="stage-1" class="stage visible">
      <h2>Stage 1 — Tank, Sump & Equipment</h2>
<section class="card">
  <h2>Guided Setup (Beginner)</h2>
  <ol class="list" style="list-style: decimal inside;">
    <li>Pick a <b>Tank size or Preset</b></li>
    <li>We’ll size your <b>Return Pump</b> and suggest <b>Powerheads</b> for flow.</li>
    <li>We’ll suggest a <b>Light Count</b> for coverage. You can tune it.</li>
    <li>Optionally add a <b>Skimmer</b> for larger/heavier systems.</li>
    <li>Check <b>Fit &amp; Sizing</b> (notes auto-update as you change things).</li>
  </ol>
  <div class="muted small">Tip: Beginner hides advanced gear (UV/Reactors) to reduce noise. Switch to Advanced any time.</div>
</section>

      <!-- Reoriented: two columns; Tank+Sump on first row, Lighting+Flow below -->
      <div class="grid grid-2">
        <div class="card">
          <h3>Tank</h3>
          <div class="row"><label>Preset Tank</label><select id="tankPreset"></select></div>
          <div class="row"><label>Build Name</label><input id="buildName" placeholder="e.g., 40g Mixed Beginner"/></div>
          <div class="row"><label>Build Type</label>
            <select id="buildType">
              <option value="mixed" selected>Mixed Reef (Soft/LPS/SPS)</option>
	      <option value="sps">SPS (Small-Polyp Stony)</option>
	      <option value="lps">LPS (Large-Polyp Stony)</option>
	      <option value="softie">Softies/Zoas (Soft Corals)</option>
	      <option value="fowlr">FOWLR (Fish Only with Live Rock)</option>

            </select>
          </div>
          <div class="row"><label>Length (in)</label><input id="lenIn" type="number" min="1" value="24"/></div>
          <div class="row"><label>Width (in)</label><input id="widIn" type="number" min="1" value="18"/></div>
          <div class="row"><label>Height (in)</label><input id="heiIn" type="number" min="1" value="18"/></div>
          <div class="row"><label>Displacement %</label><input id="displacementPct" type="number" min="0" max="50" value="10"/></div>
          <div id="tankGallonsNote" class="muted small" style="margin-top:6px;" aria-live="polite"></div>
</div>

        <div class="card">
          <h3>Sump</h3>
          <div class="row"><label>Use Sump?</label>
            <select id="useSump">
              <option value="yes" selected>Yes</option>
              <option value="no">No (AIO/Canister)</option>
            </select>
          </div>
          <div class="row"><label>Sump Model</label><select id="sumpModel"></select></div>
          <div class="row"><label>Sump Volume (gal)</label><input id="sumpGallons" type="number" min="0" value="20"/></div>
          <div class="row"><label>Skimmer Chamber Depth (in)</label><input id="skimmerWaterDepth" type="number" min="4" value="8"/></div>
          <div class="row"><label>Chamber (W×L in)</label>
            <input id="skimmerChamW" type="number" min="0" value="10" style="max-width:100px"/> ×
            <input id="skimmerChamL" type="number" min="0" value="12" style="max-width:100px"/>
          </div>
        </div>

        <div class="card">
          <h3>Lighting</h3>
          <div class="row"><label>Fixture</label>
  <div>
    <select id="lighting"></select>
    <div class="muted small">Provides PAR for corals. Cubes ≤24″ usually use one puck-style light.</div>
  </div>
</div>
<div class="row"><label>Fixture Count</label>
  <div>
    <input id="lightCount" type="number" min="1" value="1"/>
    <div class="muted small">How many fixtures. We suggest a safe starting count; adjust for coverage.</div>
  </div>
</div>


        <div class="card">
          <h3>Flow / Filtration / Heat</h3>
          <div class="row"><label>Return Pump</label>
  <div>
    <select id="returnPump"></select>
    <div class="muted small">Feeds water from sump to tank. Aim ~3–5× tank volume per hour.</div>
  </div>
</div>

<div class="row"><label>Powerhead Model</label>
  <div>
    <select id="powerhead"></select>
    <div class="muted small">Creates in-tank circulation. Together with the return, hit the flow target in Fit &amp; Sizing.</div>
  </div>
</div>

<div class="row"><label>Powerhead Count</label>
  <div>
    <input id="powerheadCount" type="number" min="0" value="1"/>
    <div class="muted small">Two smaller pumps often give better, variable flow than one large pump.</div>
  </div>
</div>

<div class="row"><label>Skimmer</label>
  <div>
    <select id="skimmer"></select>
    <div class="muted small">Removes organics. Optional for nanos; more valuable as tanks get larger/heavier.</div>
  </div>
</div>

<div class="row"><label>Heater Model</label>
  <div>
    <select id="heater"></select>
    <div class="muted small">Rule of thumb: ~3–5 W per gallon. Two smaller heaters + controller is safer.</div>
  </div>
</div>

<div class="row"><label>Heater Count</label>
  <div>
    <input id="heaterCount" type="number" min="1" value="1"/>
    <div class="muted small">Most builds use 1–2 heaters. Watch the watts/gal in Fit &amp; Sizing.</div>
  </div>
</div>

          <hr class="muted"/>
          <div class="row"><label>UV Sterilizer <span class="muted" id="uvNote"></span></label><select id="uvSterilizer"></select></div>
          <div class="row"><label>ATO System</label><select id="atoSystem"></select></div>
          <div class="row"><label>Media Reactor <span class="muted" id="reactorNote"></span></label><select id="mediaReactor"></select></div>
        </div>
      </div>
<div class="card">
  <h3>Budget</h3>
  <div id="budgetNow" class="metrics"></div>
</div>

      <div class="card">
        <h3>Fit & Sizing Check</h3>
        <div id="calcResults" class="metrics"></div>
        <div id="fitResults" class="metrics"></div>
      </div>

      <div class="nav-row">
  <div style="margin-left:auto; display:flex; gap:.5rem">
    <a class="btn primary" href="welcome.html">← Back</a>
    <button class="primary next-btn" data-next="2">Next →</button>
  </div>
</div>
    </section>

    <!-- Stage 2 -->
    <section id="stage-2" class="stage">
      <h2>Stage 2 — Fish & Invertebrates</h2>
      <div class="grid grid-2">
  <!-- LEFT COLUMN: stacked Fish then Inverts -->
  <div>
    <!-- Add Fish -->
    <div class="card">
      <h3>Add Fish</h3>
      <div class="row"><label>Fish</label><select id="fishSelect"></select></div>
      <div class="row"><label>Qty</label><input id="fishQty" type="number" min="1" value="1"/></div>
      <button id="addFish" class="primary">Add Fish</button>
    </div>

    <!-- Add Inverts -->
    <div class="card">
      <h3>Add Inverts</h3>
      <div class="row"><label>Clean-Up Crew</label><select id="invertSelect"></select></div>
      <div class="row"><label>Qty</label><input id="invertQty" type="number" min="1" value="1"/></div>
      <!-- Make this button match Add Fish -->
      <button id="addInvert" class="primary">Add Inverts</button>
    </div>
  </div>

  <!-- RIGHT COLUMN: Current Stock -->
  <div class="card">
    <h3>Current Stock</h3>
    <ul id="stockList" class="list"></ul>
    <div class="metrics" id="fishMetrics"></div>
    <div class="meter"><div id="capacityBar"></div></div>
    <div id="capacityNote" class="small muted"></div>
  </div>
</div>
<div class="nav-row">
  <div style="margin-left:auto; display:flex; gap:.5rem">
    <button class="primary back-btn" data-prev="1">← Back</button>
    <button class="primary next-btn" data-next="3">Next →</button>
  </div>
</div>

    </section>

    <!-- Stage 3 -->
    <section id="stage-3" class="stage">
      <h2>Stage 3 — Corals</h2>
      <div class="grid grid-2">
        <div class="card">
          <h3>Add Coral</h3>
          <div class="row"><label>Coral</label><select id="coralSelect"></select></div>
          <div class="row"><label>Qty</label><input id="coralQty" type="number" min="1" value="1"/></div>
          <button id="addCoral" class="primary">Add</button>
        </div>
        <div class="card">
          <h3>Coral Plan</h3>
          <ul id="coralList" class="list"></ul>
          <div class="metrics" id="coralMetrics"></div>
	  <div class="meter"><div id="parBar"></div></div>
	  <div id="parNote" class="small muted"></div>
	  <div class="meter"><div id="flowBar"></div></div>
<div id="flowNote" class="small muted"></div>

<table id="reefRanges" class="mini">
  <thead>
    <tr><th>Build</th><th>Flow×</th><th>PAR</th></tr>
  </thead>
  <tbody id="reefRangesBody"></tbody>
</table>

        </div>
      </div>
      <div class="nav-row">
  <div style="margin-left:auto; display:flex; gap:.5rem">
    <button class="primary back-btn" data-prev="2">← Back</button>
    <button class="primary next-btn" data-next="4">Next →</button>
  </div>
</div>
    </section>

    <!-- Stage 4 -->
    <section id="stage-4" class="stage">
      <h2>Summary</h2>
<div class="card">
  <h3>Budget Summary</h3>
  <div id="budgetSummary"></div>
</div>
      <div id="summary" class="card"></div>
      <div class="nav-row">
  <div style="margin-left:auto; display:flex; gap:.5rem">
    <button class="primary back-btn" data-prev="3">← Back</button>
    <button class="primary restart-btn">⟳ Restart</button>
    <button id="exportPdfPortrait" class="primary">Export</button>
    <button class="primary" id="goViz" data-next="5">Visualize →</button>
  </div>
</div>
    </section>

<section class="stage" id="stage-5" aria-label="3-D Visualizer">
  <div class="card">
    <h2>Blueprint 3-D Visualizer</h2>
    <p class="muted">NOTE: This is a concept visualizer and currently a work in progress. Use the different viewing options to visualize your setup. Use the toggles to show/hide overlays.and use your mouse to orbit (drag), right-drag to pan, and scroll to zoom.</p>

    <!-- Simple toolbar -->
    <div class="row" style="gap:8px; margin-bottom:10px;">
      <label><input type="checkbox" id="vizShowLights" checked> Show light cones</label>
      <label><input type="checkbox" id="vizShowFlow" checked> Show flow arrows</label>
      <button id="vizViewTop" class="secondary">Top</button>
      <button id="vizViewFront" class="secondary">Front</button>
      <button id="vizViewIso" class="secondary">¾ View</button>
      <button id="vizScreenshot" class="secondary">Save Screenshot</button>
    </div>

    <section class="card" id="vizContainer">
  <!-- NEW: compact equipment summary bar -->
  <div id="vizEquip" class="metrics" style="margin-bottom:10px"></div>

  <div id="viz3d"></div>

  <p id="vizNote" class="muted" style="margin-top:8px;">
    NOTE: This is a concept visualizer and currently a work in progress. Use the different viewing options to visualize your setup. Use the toggles to show/hide overlays.and use your mouse to orbit (drag), right-drag to pan, and scroll to zoom.
  </p>
</section>

<div class="nav-row">
         <div style="margin-left:auto; display:flex; gap:.5rem">
             <button class="primary back-btn" id="vizBack" data-prev="4">← Back</button>
          </div>
      </div>
 </div>
</section>

  </main>

  <!-- Glossary Modal (fixed overlay, hidden by default) -->
  <div id="glossaryModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Glossary (Beginner)</h3>
        <button id="closeGlossary" class="icon-btn">Close</button>
      </div>
      <div class="modal-body">
  <h4>System & Equipment</h4>
  <ul>
    <li><b>AIO (All-In-One)</b> — Display tank with built-in rear filtration chambers; no external sump.</li>
    <li><b>Sump</b> — Separate tank in the stand that adds water volume and hides gear.</li>
    <li><b>Return Pump</b> — Pushes water from sump to display; helps set turnover (3–5×/hr).</li>
    <li><b>Powerhead / Wavemaker</b> — In-tank circulation pump for internal flow.</li>
    <li><b>Protein Skimmer</b> — Removes dissolved organics with foam fractionation; boosts oxygenation.</li>
    <li><b>Refugium</b> — Low-flow zone (often in sump) growing macroalgae/pods for natural nutrient export.</li>
    <li><b>ATO (Auto Top-Off)</b> — Adds fresh water to offset evaporation and keep salinity stable.</li>
    <li><b>Media Reactor</b> — Chamber that forces water through media (e.g., carbon, GFO).</li>
    <li><b>GFO</b> — Granular Ferric Oxide; binds phosphate (PO₄).</li>
  </ul>

  <h4>Planning, Layout & Safety</h4>
  <ul>
    <li><b>Aquascape</b> — Rock structure for stability, flow, and coral placement.</li>
    <li><b>Drip Loop</b> — Cable routing below the outlet to prevent water intrusion.</li>
    <li><b>Turnover Rate</b> — Return flow ÷ display gallons (target ~3–5×/hr).</li>
    <li><b>Total Flow</b> — (Return + powerheads) ÷ gallons; varies by coral type.</li>
  </ul>

  <h4>Water & Salt</h4>
  <ul>
    <li><b>RODI</b> — Reverse Osmosis + Deionization; near-zero TDS source water.</li>
    <li><b>TDS</b> — Total Dissolved Solids (ppm); aim ≤5, ideally 0 for mixing.</li>
    <li><b>DI Resin</b> — Final RODI stage that “polishes” water; replace when TDS rises.</li>
    <li><b>Salinity</b> — 35 ppt (~1.025–1.026 SG); measure with refractometer.</li>
    <li><b>Refractometer</b> — Optical tool for salinity; calibrate with 35 ppt fluid.</li>
  </ul>

  <h4>Core Parameters</h4>
  <ul>
    <li><b>Alkalinity (dKH)</b> — Buffers pH; supports skeletal growth (target ~8–12 dKH).</li>
    <li><b>Calcium (Ca)</b> — Coral skeleton component (target ~400–450 ppm).</li>
    <li><b>Magnesium (Mg)</b> — Helps prevent Ca/Alk precipitation (target ~1250–1350 ppm).</li>
    <li><b>pH</b> — Acidity/alkalinity (typ. 7.9–8.3).</li>
    <li><b>Temperature</b> — 77–80 °F (25–27 °C) with minimal daily swing.</li>
  </ul>

  <h4>Nitrogen Cycle</h4>
  <ul>
    <li><b>Seed</b> — Introduce live bacteria (bottled or live rock/sand) to start cycling.</li>
    <li><b>Ammonia (NH₃/NH₄⁺)</b> — Toxic waste; first stage of the cycle.</li>
    <li><b>Nitrite (NO₂⁻)</b> — Toxic intermediate; spikes mid-cycle.</li>
    <li><b>Nitrate (NO₃⁻)</b> — End product; controlled by water changes/algae uptake.</li>
    <li><b>Cycle Complete</b> — Ammonia = 0, Nitrite = 0, Nitrate present.</li>
    <li><b>Biofilter</b> — Surfaces (rock/sand/media) where bacteria colonize.</li>
    <li><b>Diatoms</b> — Early brown film algae; common during/after cycling.</li>
  </ul>

  <h4>Flow, Filtration & Nutrients</h4>
  <ul>
    <li><b>Laminar Flow</b> — Straight, constant stream; can be harsh if direct.</li>
    <li><b>Random/Gyre Flow</b> — Alternating, sweeping currents; reduces dead spots.</li>
    <li><b>Pulse/Wave</b> — On/off rhythm; gentle sway (popular for LPS/softies).</li>
    <li><b>Dead Spot</b> — Area with little/no flow where detritus accumulates.</li>
    <li><b>Bioload</b> — Total waste production from livestock.</li>
    <li><b>Nitrate (NO₃)</b> — Target ~2–20 ppm for reefs.</li>
    <li><b>Phosphate (PO₄)</b> — Target ~0.01–0.2 ppm (keep balanced with NO₃).</li>
  </ul>

  <h4>Lighting</h4>
  <ul>
    <li><b>PAR</b> — Photosynthetically Active Radiation; usable light for corals.</li>
    <li><b>Spectrum</b> — Blend of wavelengths (blue/UV heavy for photosynthesis).</li>
    <li><b>Photoperiod</b> — Daily duration of light.</li>
    <li><b>Kelvin (K)</b> — Color temperature (10–14K daylight to bluer reef looks).</li>
    <li><b>Bleaching</b> — Loss of symbiotic algae due to excess light/heat/stress.</li>
    <li><b>FOWLR</b> — Fish Only With Live Rock (light mainly for viewing/aesthetics).</li>
  </ul>

  <h4>Stocking & Acclimation</h4>
  <ul>
    <li><b>CUC (Clean-Up Crew)</b> — Snails/hermits that manage algae and waste.</li>
    <li><b>Quarantine (QT)</b> — Temporary isolation to observe/treat fish.</li>
    <li><b>Drip Acclimation</b> — Gradual mixing of tank and shipping water.</li>
    <li><b>Coral Dip</b> — Anti-pest rinse before adding corals to display.</li>
    <li><b>Compatibility</b> — Likelihood species co-exist peacefully.</li>
  </ul>

  <h4>Maintenance & Upgrades</h4>
  <ul>
    <li><b>Trace Elements</b> — Minor minerals replenished by water changes.</li>
    <li><b>Detritus</b> — Organic debris that breaks down to nutrients if not removed.</li>
    <li><b>Vinegar Bath</b> — 1:1 vinegar/water soak to remove mineral buildup.</li>
    <li><b>Dosing Pump</b> — Automates Alk/Ca/Mg additions.</li>
    <li><b>Calibration</b> — Re-checking instruments (probes, refractometer, heaters).</li>
  </ul>
</div>

    </div>
  </div>

  <footer class="footer">
    <span>Reef Architect v11.6 — © 2025</span>
  </footer>

<!-- Old static data files no longer needed
<script src="data_tanks.js"></script>
<script src="data_equipment.js"></script>
<script src="data_species.js"></script>
-->
<!-- Try CDN first -->
<!-- Modern Three.js (r170+) as ES module -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.min.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>

<!-- Load the current module build, expose globals for legacy scripts -->
<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  // Create a plain, extensible object for legacy scripts:
  window.THREE = Object.assign({}, THREE, { OrbitControls });

  // Also expose the class directly (in case visualizer.js checks this):
  window.OrbitControls = OrbitControls;
</script>

<!-- Now your existing scripts will see THREE + OrbitControls -->
<script src="visualizer.js"></script>
<script src="app.js"></script>

</body>
</html>
